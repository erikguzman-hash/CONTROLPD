<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLPD - HGIO</title>
    <link rel="icon" type="image/x-icon" href="https://hgio-basics-images.s3.us-east-1.amazonaws.com/hgio-logos/apps-logos/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'] },
                    colors: { 'hgio-blue': { DEFAULT: '#153054', dark: '#102440' }, 'hgio-green': { DEFAULT: '#4c9200', light: '#80ba27' }, 'hgio-gray': '#858482' }
                }
            }
        }
    </script>
    
    <style>
        body { background-image: url('https://hgio-basics-images.s3.us-east-1.amazonaws.com/hgio-fondos/background.png'); background-size: cover; background-position: center; background-attachment: fixed; }
        .loader { border-top-color: #4c9200; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .fc-daygrid-event { white-space: normal; }
        .fc-event { cursor: pointer; }
        .tab-btn.active { border-color: #153054; background-color: #153054; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-solicitado { background-color: #E0E7FF; color: #3730A3; }
        .status-pendiente { background-color: #FEF3C7; color: #92400E; }
        .status-aprobado-coord { background-color: #D1FAE5; color: #065F46; }
        .status-aprobado-dir { background-color: #C6F6D5; color: #22543D; }
        .status-rechazado { background-color: #FEE2E2; color: #991B1B; }
        .status-finalizado { background-color: #E5E7EB; color: #374151; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-view" class="min-h-screen flex items-center justify-center bg-white"><div class="loader h-32 w-32"></div></div>

    <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://hgio.co/wp-content/uploads/Logo_Transparente-41.webp" alt="Logo HGIO" class="h-24 w-auto mx-auto object-contain">
                <h1 class="text-2xl font-bold text-hgio-blue mt-4">CONTROLPD</h1>
                <p class="text-hgio-gray mt-1">Inicia sesión para continuar</p>
            </div>
            <div class="space-y-4">
                <button id="google-signin-button" class="w-full flex items-center justify-center py-2.5 px-4 border rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FBBC05" d="M27.463,25.309l-6.571,4.819C20.534,34.91,19.287,36,17.64,36c-3.356,0-6.21-2.344-7.175-5.443l-6.571,4.819C6.963,42.422,12.682,46,20,46c6.627,0,12-5.373,12-12c0-2.42-0.734-4.645-2.039-6.539z"></path><path fill="#EA4335" d="M20.184,43.725l6.571-4.819C29.463,34.91,30.713,36,32.36,36c3.356,0-6.21-2.344-7.175-5.443l6.571,4.819C41.037,42.422,35.318,46,28,46C25.463,46,22.926,45.28,20.184,43.725z"></path></svg>
                    Iniciar Sesión con Google
                </button>
            </div>
        </div>
    </div>

    <div id="app-view" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto py-3 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-3"><img src="https://hgio.co/wp-content/uploads/Logo_Transparente-41.webp" alt="Logo HGIO" class="h-12 w-auto object-contain"><h1 class="text-xl font-bold text-hgio-blue">CONTROLPD</h1></div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <span id="user-name" class="font-semibold text-hgio-blue block"></span>
                        <span id="user-role" class="text-xs text-hgio-gray block"></span>
                    </div>
                    <button id="logout-button" class="text-sm bg-hgio-blue text-white py-2 px-4 rounded-md font-semibold">Cerrar Sesión</button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="mb-6 flex justify-between items-center">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="calendar">Calendario</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500" data-tab="dashboard">Estadísticas</button>
                        <button id="admin-tab-btn" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hidden" data-tab="admin">Admin</button>
                    </nav>
                </div>
                 <button id="create-task-btn" class="bg-hgio-green text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-hgio-green-light">+ Nueva Tarea</button>
            </div>

            <div id="calendar-content" class="tab-content active bg-white p-4 rounded-lg shadow-md"><div id="calendar"></div></div>
            <div id="dashboard-content" class="tab-content"><div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div>
            <div id="admin-content" class="tab-content bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-hgio-blue mb-4">Gestión de Usuarios</h2>
                <div id="user-management-table" class="overflow-x-auto"></div>
            </div>
        </main>
    </div>

    <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <form id="task-form" class="w-full">
                <div class="p-5 border-b flex justify-between items-center">
                    <h2 id="task-modal-title" class="text-2xl font-bold text-hgio-blue"></h2>
                    <button type="button" class="close-modal-btn text-3xl text-hgio-gray hover:text-black">&times;</button>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="task-id">
                    <div>
                        <label for="task-title" class="block text-sm font-medium text-gray-700">Título de la Tarea</label>
                        <input type="text" id="task-title" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <textarea id="task-description" rows="4" class="mt-1 w-full p-2 border rounded-md"></textarea>
                    </div>
                    <div>
                        <label for="task-assignee" class="block text-sm font-medium text-gray-700">Asignar a</label>
                        <select id="task-assignee" class="mt-1 w-full p-2 border rounded-md bg-white" required></select>
                    </div>
                     <div>
                        <label for="task-due-date" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                        <input type="date" id="task-due-date" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div id="task-details-readonly" class="hidden space-y-3 text-sm"></div>
                </div>
                <div id="task-modal-footer" class="p-4 bg-gray-50 border-t flex justify-end items-center space-x-3"></div>
            </form>
        </div>
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB8-KNE_60SD9OmavwOG816L5dGxOAgzO4",
            authDomain: "weekpd.firebaseapp.com",
            projectId: "weekpd",
            storageBucket: "weekpd.firebasestorage.app",
            messagingSenderId: "712077553599",
            appId: "1:712077553599:web:07fa4b6309af0e50ecfb0a",
            measurementId: "G-CXM1ZQ7VFL"
        };
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script>

        // --- INICIALIZACIÓN DE FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // --- OBJETO PRINCIPAL DE LA APLICACIÓN ---
        const App = {
            state: {
                currentUser: null,
                currentUserRole: null,
                calendar: null,
                unsubscribeTasks: null, // Para detener el listener de Firestore
            },
            
            ui: {
                elements: {
                    loadingView: document.getElementById('loading-view'),
                    loginView: document.getElementById('login-view'),
                    appView: document.getElementById('app-view'),
                    googleSigninButton: document.getElementById('google-signin-button'),
                    logoutButton: document.getElementById('logout-button'),
                    createTaskBtn: document.getElementById('create-task-btn'),
                    userNameSpan: document.getElementById('user-name'),
                    userRoleSpan: document.getElementById('user-role'),
                    adminTabBtn: document.getElementById('admin-tab-btn'),
                    tabs: document.querySelectorAll('.tab-btn'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    taskModal: document.getElementById('task-modal'),
                    taskModalTitle: document.getElementById('task-modal-title'),
                    taskForm: document.getElementById('task-form'),
                    closeModalBtns: document.querySelectorAll('.close-modal-btn'),
                    userManagementTable: document.getElementById('user-management-table'),
                    statsContainer: document.getElementById('stats-container'),
                },

                showView(view) {
                    this.elements.loadingView.classList.add('hidden');
                    this.elements.loginView.classList.add('hidden');
                    this.elements.appView.classList.add('hidden');
                    if (view === 'loading') this.elements.loadingView.classList.remove('hidden');
                    if (view === 'login') this.elements.loginView.classList.remove('hidden');
                    if (view === 'app') this.elements.appView.classList.remove('hidden');
                },

                updateUserInfo(user, role) {
                    this.elements.userNameSpan.textContent = user.displayName;
                    const roleCapitalized = role.charAt(0).toUpperCase() + role.slice(1);
                    this.elements.userRoleSpan.textContent = roleCapitalized;
                    if (role === 'director' || role === 'coordinador') {
                        this.elements.adminTabBtn.classList.remove('hidden');
                    } else {
                        this.elements.adminTabBtn.classList.add('hidden');
                    }
                },
                
                resetAppView() {
                     if (App.state.unsubscribeTasks) App.state.unsubscribeTasks();
                     this.elements.adminTabBtn.classList.add('hidden');
                     this.elements.userNameSpan.textContent = '';
                     this.elements.userRoleSpan.textContent = '';
                },
            },

            auth: {
                async handleAuthStateChange(user) {
                    if (user) {
                        App.state.currentUser = user;
                        const userDoc = await App.firestore.getUser(user.uid);

                        if (userDoc.exists) {
                            App.state.currentUserRole = userDoc.data().role;
                        } else {
                            await App.firestore.createUser(user);
                            App.state.currentUserRole = 'equipo';
                        }
                        
                        App.ui.updateUserInfo(user, App.state.currentUserRole);
                        App.ui.showView('app');
                        App.calendar.initialize();
                        App.firestore.listenForTasks();
                    } else {
                        App.state.currentUser = null;
                        App.state.currentUserRole = null;
                        App.ui.resetAppView();
                        App.ui.showView('login');
                    }
                },
                
                async signInWithGoogle() {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        await auth.signInWithPopup(provider);
                    } catch (error) {
                        console.error("Error al iniciar sesión con Google:", error);
                        alert("Error al iniciar sesión. Verifica la consola para más detalles.");
                    }
                },

                async signOut() {
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error("Error al cerrar sesión:", error);
                        alert("Error al cerrar sesión. Verifica la consola para más detalles.");
                    }
                },
            },
            
            firestore: {
                getUser: (uid) => db.collection("users").doc(uid).get(),
                
                createUser: (user) => db.collection("users").doc(user.uid).set({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    role: 'equipo',
                    createdAt: serverTimestamp()
                }),
                
                listenForTasks() {
                    App.state.unsubscribeTasks = db.collection("tasks").onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            const taskData = change.doc.data();
                            const event = App.calendar.formatTaskToEvent(taskData, change.doc.id);

                            if (change.type === "added") {
                                App.state.calendar.addEvent(event);
                            }
                            if (change.type === "modified") {
                                const existingEvent = App.state.calendar.getEventById(change.doc.id);
                                if (existingEvent) existingEvent.remove();
                                App.state.calendar.addEvent(event);
                            }
                            if (change.type === "removed") {
                                const existingEvent = App.state.calendar.getEventById(change.doc.id);
                                if (existingEvent) existingEvent.remove();
                            }
                        });
                    });
                }
            },

            calendar: {
                initialize() {
                    const calendarEl = document.getElementById('calendar');
                     if (App.state.calendar) App.state.calendar.destroy();

                    App.state.calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                        locale: 'es',
                        eventClick: (info) => App.tasks.openModal(info.event.id),
                    });
                    App.state.calendar.render();
                },

                getStatusColor(status) {
                    const colors = {
                        'solicitado': '#E0E7FF', 'pendiente': '#FEF3C7', 'aprobado-coord': '#D1FAE5',
                        'aprobado-dir': '#C6F6D5', 'rechazado': '#FEE2E2', 'finalizado': '#E5E7EB'
                    };
                    return colors[status] || '#F3F4F6';
                },

                formatTaskToEvent(task, id) {
                    const color = this.getStatusColor(task.status);
                    return {
                        id: id,
                        title: task.title,
                        start: task.dueDate,
                        allDay: true,
                        backgroundColor: color,
                        borderColor: color,
                        textColor: '#1F2937' // Mejor contraste
                    };
                },
            },

            tasks: {
                 async openModal(taskId = null) {
                    App.ui.elements.taskForm.reset();
                    await this.populateUsersDropdown();

                    const { taskDetailsReadonly, taskModalFooter } = App.ui.elements;
                    const formInputs = [
                        document.getElementById('task-title'), document.getElementById('task-description'),
                        document.getElementById('task-assignee'), document.getElementById('task-due-date')
                    ];
                    
                    taskDetailsReadonly.classList.add('hidden');
                    taskModalFooter.innerHTML = '';
                    formInputs.forEach(input => {
                        input.parentElement.style.display = 'block'; // Mostrar el div contenedor
                        input.disabled = false;
                    });
                    
                    if (taskId) {
                        App.ui.elements.taskModalTitle.textContent = 'Detalles de la Tarea';
                        const taskDoc = await db.collection("tasks").doc(taskId).get();

                        if (taskDoc.exists) {
                            const task = taskDoc.data();
                            document.getElementById('task-id').value = taskId;
                            
                            // Vista de solo lectura
                            if (App.state.currentUser.uid !== task.creatorId && App.state.currentUserRole === 'equipo') {
                                formInputs.forEach(input => input.parentElement.style.display = 'none');
                                taskDetailsReadonly.classList.remove('hidden');
                                taskDetailsReadonly.innerHTML = `
                                    <p><strong>Título:</strong> ${task.title}</p>
                                    <p><strong>Descripción:</strong> ${task.description || 'N/A'}</p>
                                    <p><strong>Asignado a:</strong> ${task.assigneeName}</p>
                                    <p><strong>Fecha de Entrega:</strong> ${task.dueDate}</p>
                                    <p><strong>Estado:</strong> <span class="status-badge status-${task.status}">${task.status}</span></p>`;
                            } else { // Vista de edición
                                document.getElementById('task-title').value = task.title;
                                document.getElementById('task-description').value = task.description || '';
                                document.getElementById('task-assignee').value = task.assigneeId;
                                document.getElementById('task-due-date').value = task.dueDate;
                            }
                            this.addWorkflowButtons(taskModalFooter, task, taskId);
                        }
                    } else {
                        App.ui.elements.taskModalTitle.textContent = 'Crear Nueva Tarea';
                        document.getElementById('task-id').value = '';
                        taskModalFooter.innerHTML = '<button type="submit" class="bg-hgio-green text-white font-bold py-2 px-5 rounded-lg">Guardar Tarea</button>';
                    }
                    App.ui.elements.taskModal.classList.add('is-open');
                },

                addWorkflowButtons(container, task, taskId) {
                    container.innerHTML = '';
                    const taskDocRef = db.collection("tasks").doc(taskId);
                    const { currentUser, currentUserRole } = App.state;

                    // Botón de Guardar
                    if (currentUser.uid === task.creatorId || currentUserRole === 'coordinador' || currentUserRole === 'director') {
                        container.appendChild(this.createButton('submit', 'Guardar Cambios', 'bg-hgio-blue'));
                    }
                    // Botón Aprobar (Coord)
                    if (currentUserRole === 'coordinador' && task.status === 'solicitado') {
                         container.appendChild(this.createButton('button', 'Aprobar (Coord.)', 'bg-green-500', () => taskDocRef.update({ status: 'aprobado-coord' })));
                    }
                    // Botón Aprobar (Dir)
                    if (currentUserRole === 'director' && task.status === 'aprobado-coord') {
                        container.appendChild(this.createButton('button', 'Aprobar (Dir.)', 'bg-green-700', () => taskDocRef.update({ status: 'aprobado-dir' })));
                    }
                    // Botón Rechazar
                    if ((currentUserRole === 'coordinador' && task.status === 'solicitado') || (currentUserRole === 'director' && task.status === 'aprobado-coord')) {
                         container.appendChild(this.createButton('button', 'Rechazar', 'bg-red-500', () => taskDocRef.update({ status: 'rechazado' })));
                    }
                    // Botón Finalizar Tarea
                    if (task.assigneeId === currentUser.uid && task.status === 'aprobado-dir') {
                         container.appendChild(this.createButton('button', 'Marcar como Finalizada', 'bg-gray-500', () => taskDocRef.update({ status: 'finalizado' })));
                    }
                },

                createButton(type, text, className, onClick) {
                    const button = document.createElement('button');
                    button.type = type;
                    button.textContent = text;
                    button.className = `${className} text-white font-bold py-2 px-4 rounded-lg`;
                    if (onClick) button.onclick = onClick;
                    return button;
                },

                closeModal() {
                    App.ui.elements.taskModal.classList.remove('is-open');
                },

                async handleSubmit(e) {
                    e.preventDefault();
                    const taskId = document.getElementById('task-id').value;
                    const assigneeSelect = document.getElementById('task-assignee');
                    
                    const taskData = {
                        title: document.getElementById('task-title').value,
                        description: document.getElementById('task-description').value,
                        assigneeId: assigneeSelect.value,
                        assigneeName: assigneeSelect.selectedOptions[0].text,
                        dueDate: document.getElementById('task-due-date').value,
                        updatedAt: serverTimestamp(),
                    };

                    if (taskId) {
                        await db.collection("tasks").doc(taskId).update(taskData);
                    } else {
                        taskData.creatorId = App.state.currentUser.uid;
                        taskData.creatorName = App.state.currentUser.displayName;
                        taskData.status = 'solicitado';
                        taskData.createdAt = serverTimestamp();
                        await db.collection("tasks").add(taskData);
                    }
                    App.tasks.closeModal();
                },

                async populateUsersDropdown() {
                    const userSelect = document.getElementById('task-assignee');
                    userSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
                    const snapshot = await db.collection("users").orderBy('displayName').get();
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const option = document.createElement('option');
                        option.value = user.uid;
                        option.textContent = user.displayName;
                        userSelect.appendChild(option);
                    });
                }
            },
            
            dashboard: {
                async load() {
                    const snapshot = await db.collection("tasks").get();
                    const tasksByUser = {};
                    snapshot.forEach(doc => {
                        const task = doc.data();
                        if (task.assigneeName) {
                            tasksByUser[task.assigneeName] = (tasksByUser[task.assigneeName] || 0) + 1;
                        }
                    });
                    
                    App.ui.elements.statsContainer.innerHTML = '';
                    const chartCanvas = document.createElement('canvas');
                    App.ui.elements.statsContainer.appendChild(chartCanvas);

                    new Chart(chartCanvas, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(tasksByUser),
                            datasets: [{
                                label: 'Tareas por Usuario',
                                data: Object.values(tasksByUser),
                                backgroundColor: 'rgba(76, 146, 0, 0.5)',
                                borderColor: 'rgba(76, 146, 0, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, stepSize: 1 } } }
                    });
                }
            },
            
            admin: {
                async load() {
                    const { currentUserRole } = App.state;
                    if (currentUserRole !== 'director' && currentUserRole !== 'coordinador') return;
                    
                    const tableContainer = App.ui.elements.userManagementTable;
                    tableContainer.innerHTML = `
                        <table class="min-w-full bg-white">
                            <thead class="bg-hgio-blue text-white">
                                <tr>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Usuario</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Email</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Rol</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody"></tbody>
                        </table>`;

                    const tableBody = document.getElementById('user-list-tbody');
                    const snapshot = await db.collection("users").orderBy('displayName').get();
                    snapshot.forEach(doc => {
                        tableBody.appendChild(this.renderUserRow(doc.data()));
                    });
                },

                renderUserRow(user) {
                    const row = document.createElement('tr');
                    const { currentUserRole } = App.state;

                    row.innerHTML = `
                        <td class="text-left py-3 px-4">${user.displayName}</td>
                        <td class="text-left py-3 px-4">${user.email}</td>
                        <td class="text-left py-3 px-4"></td>`;

                    const select = document.createElement('select');
                    select.className = "role-select border rounded-md p-1";
                    select.dataset.uid = user.uid;
                    if (currentUserRole !== 'director') select.disabled = true;

                    ['equipo', 'coordinador', 'director'].forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                        if (user.role === role) option.selected = true;
                        select.appendChild(option);
                    });
                    
                    select.addEventListener('change', (e) => this.updateUserRole(e.target.dataset.uid, e.target.value));
                    row.cells[2].appendChild(select);

                    return row;
                },

                async updateUserRole(uid, newRole) {
                    try {
                        await db.collection("users").doc(uid).update({ role: newRole });
                        // Opcional: mostrar una notificación de éxito
                    } catch (error) {
                        console.error("Error al actualizar el rol:", error);
                        alert("No se pudo actualizar el rol.");
                    }
                }
            },

            // --- MÉTODO DE INICIALIZACIÓN GENERAL ---
            init() {
                auth.onAuthStateChanged(this.auth.handleAuthStateChange);
                
                this.ui.elements.googleSigninButton.addEventListener('click', this.auth.signInWithGoogle);
                this.ui.elements.logoutButton.addEventListener('click', this.auth.signOut);
                this.ui.elements.createTaskBtn.addEventListener('click', () => this.tasks.openModal());
                this.ui.elements.taskForm.addEventListener('submit', (e) => this.tasks.handleSubmit(e));
                this.ui.elements.closeModalBtns.forEach(btn => btn.addEventListener('click', this.tasks.closeModal));

                this.ui.elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.ui.elements.tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const tabName = tab.dataset.tab;
                        this.ui.elements.tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabName}-content`) {
                                content.classList.add('active');
                            }
                        });
                        // Carga de contenido on-demand
                        if(tabName === 'dashboard') this.dashboard.load();
                        if(tabName === 'admin') this.admin.load();
                    });
                });
            }
        };

        // --- INICIAR LA APLICACIÓN ---
        App.init();

    </script>
</body>
</html>